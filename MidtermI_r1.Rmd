---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
rm(list = ls())
air_m=read.csv("C:\\Users\\Azamat\\Downloads\\monthly-us-air-passenger-miles.csv")
#plot air time series data
plot.ts(air_m$air.passenger.miles)
#make monthly time series data from Jan 1960 to DEc 1977
air_time=ts(data=air_m$air.passenger.miles, frequency=12, start=c(1960, 1))
length(air_time)

length(air_m$air.passenger.miles)
```

```{r}
length(air_time)
month = rep(1:12,18)
```

```{r}
fit = lm(air_time~time(air_time) + factor(month))
summary(fit)
```

```{r}
fac=factor(month)
fac
```

```{r}
dummies = table(1:length(month), as.factor(month))
mod=(lm(air_time~0+time(air_time) + dummies[,1:11]))
summary(mod)
acf(mod$res)
pacf(mod$res)
```

```{r}
mod1=(lm(air_time~time(air_time) + dummies[,c(2,6:8,11)]))
summary(mod1)
acf(resid(mod1))
pacf(resid(mod1))
```

```{r}
pred = c(fitted(mod1), -1769+0.9023*c(1978.01, 1978.02, 1978.03, 1978.04, 1978.05, 1978.06, 1978.07, 1978.08, 1978.09, 1978.10, 1978.11, 1978.12) + c(0, -0.954, 0, 0, 0, 1.119, 1.449, 1.952, 0, 0, -1.031, 0))
plot( c(time(air_time), 1978.000, 1978.083, 1978.167, 1978.250, 1978.333, 1978.417, 1978.500, 1978.583, 1978.667, 1978.750, 1978.833, 1978.917), pred, type='l', main="1 Year Prediction and Air Passengers Data")
points(air_time, type='o', col='red')
pred
```

```{r}
mod1=lm(air_time~0 + time(air_time))
summary(mod1)
mod1$coefficients
```

```{r}
#mod2 = lm(air_time ~ time(air_time))
#predict(mod2, data.frame(pred), interval="prediction")
```

```{r}
#pred
```

```{r}
summary(mod1)
rs<-rstandard(mod1)
fits<-fitted.values(mod1)
```

```{r}
qqnorm(rs)
qqline(rs,col=2)
shapiro.test(rs)
```

Normality assumptions is not met either. P value=0.002

```{r}
#install.packages("car")
library(car)
```

```{r}
plot(fits,rs,main="residuals vs. fitted values")
```

Equal variance is not seems reasonable. Obviuously we can see pattern in plot residuals vs fitted values plot

```{r}
par(mfrow = c(2, 2), oma = c(0, 0, 2, 0))
plot(mod1)
```
#3a)

```{r}
milk=read.csv("C:\\Users\\Azamat\\Downloads\\milk.csv")
milk_time=ts(data=milk$Prod, frequency=12, start=c(1962, 1))
plot(milk_time)
```
Does a transformation appear necessary for this data (if so, state a transfromation that
could be used). Discuss any other relavent feaures of the plot.

It does not the series appear stationary. We can see seasonal fluctuations across the time.
We can see some the increasing trend in the plot and we need detrend these data. 
Differencing helps to detrend these time series data.

```{r}
plot(log(milk_time))
```

This plot shows no problem with variability of data. Both plots look similar, and we
still have increasing trend.

```{r}
library(astsa)
acf2(milk_time, max.lag = 167)
```

The plots ACF and PACF that show above confirm variability of data. We can also see
the cycle that equals 1 year.

```{r}
diff=diff(log(milk_time))
plot(diff)
acf2(diff)
```

We are going to take log of data to stabilize variability and difference data to eliminate
trend. The plot of differencing of log of data looks nicer, but we still have problem
with stationarity as it is shown in ACF plot of transformed data (strong correlation
at h=1, 2, 3, 4). Anyway, let's assume normality of residuals to apply time series
regression for the log of transformed data.

#3b)

```{r}
M3 = factor(cycle(milk_time))
#M3
trend3 = time(milk_time)-1969 #centered data
reg3    = lm(log(milk_time) ~ trend3 + M3, na.action=NULL)
summary(reg3)
#model.matrix(reg3) #trend is time centered at 1969
```

We can see that from table above that both trend and seasonal components are significant,
except month August. Adjusted R^2 shows good fit = 0.9679. Let's perform residual diagnostics.

#3d)
```{r}
plot(reg3)
shapiro.test(reg3$residuals)
```

Plot of Residuals versus of fitted values shows violation of const variance. 
However, Shapiro test and QQ plot shows that normality of assumption are met (p=0.45).
It seems like we do not have any influenced outliers as well.

#3.C)
```{r}
acf(reg3$residuals)
```

ACF shows that our fitted model is not good. The process does not look like a white 
noise. We Still have problem with stationarity.

3e)

```{r}
summary(reg3)
```


```{r}
#time(milk_time)
```


```{r}

pred3 = c(fitted(reg3), 6.596+0.028*c(1976.000, 1976.083, 1976.167, 1976.250, 1976.333, 1976.417, 1976.500, 1976.583, 1976.667, 1976.750, 1976.833, 1976.917) + c(0, -0.555, 0.071, 0.09, 0.164, 0.13, 0.07, 0, -0.048, -0.043, -0.087, 0.034))
plot( c(time(milk_time), 1976.000, 1976.083, 1976.167, 1976.250, 1976.333, 1976.417, 1976.500, 1976.583, 1976.667, 1976.750, 1976.833, 1976.917), pred3, type='l', main="1 Year Prediction for Milk Production Data")
points(milk_time, type='o', col='red')
#pred3
```

```{r}
month3  = rep(1:12, 14)
dummies3 = table(1:length(month3), as.factor(month3))
```

```{r}
reg03 = lm(milk_time~time(milk_time)+dummies3[,1:11])
summary(reg03)
```

```{r}
reg_3 = lm(milk_time~time(milk_time)+dummies3[,c(1, 3:8, 11)])
summary(reg_3)
```

```{r}
pred3 = c(fitted(reg_3), -40180+20.75*c(1976.000, 1976.083, 1976.167, 1976.250, 1976.333, 1976.417, 1976.500, 1976.583, 1976.667, 1976.750, 1976.833, 1976.917) + c(32.42, 0, 85.39, 100.2, 161.2, 132.8, 83.04, 40.74, 0, 0, -29.38, 0))
plot( c(time(milk_time), 1976.000, 1976.083, 1976.167, 1976.250, 1976.333, 1976.417, 1976.500, 1976.583, 1976.667, 1976.750, 1976.833, 1976.917), pred3, type='l', ylim = c(500, 1000))
points(milk_time, type='o', col='red')
pred3
```

```{r}
#attach(faithful)     # attach the data frame 
eruption.lm = lm(eruptions ~ waiting)
summary(eruption.lm)
newdata = data.frame(waiting=80)
pr=predict(eruption.lm, newdata, se.fit=TRUE, interval="predict") 
```

```{r}
pr
se.PI=sqrt(pr$se.fit^2 + pr$residual.scale^2)
se.PI
alpha <- 1.968789
PI <- pr$fit + c(alpha, -alpha) * se.PI
PI
```

 
```{r}
(qt(0.975, 270)*0.4965 + 4.17622)
```
```{r}
qt((1-0.95)/2, 270, lower.tail = FALSE)
```

```{r}
se.PI=sqrt(pr$se.fit^2 + pr$residual.scale^2)
se.PI
#alpha <- 1.968789
alpha=qt((1-0.95)/2, df = pr$df)
PI <- 4.17622 + c(alpha, -alpha) * se.PI
PI
```


```{r}
pi3 = lm(milk_time~time(milk_time))
summary(pi3)
tm=time(milk_time)
t = data.frame(tm=1976.917)
pr=predict(pi3, t, se.fit=TRUE, interval="predict")                
```

```{r}
pr=predict(pi3, t, se.fit=TRUE, interval="predict")
```


```{r}
#forecast(pi3, 12)
#plot(forecast(pi3, 12))
```


```{r}
#plot(time(milk_time), fitted(reg_3), col='red', type='l')
#lines(milk_time)
```


```{r}
#reg_3 = lm(milk_time~time(milk_time)+dummies3[,c(3:7)])
#summary(reg_3)
```

```{r}
#plot(time(milk_time), fitted(reg_3), col='red', type='l')
#lines(milk_time)
```



```{r}
#pred3 = c(fitted(reg_3), -39930+20.64*c(1976.000, 1976.083, 1976.167, 1976.250, 1976.333, 1976.417, 1976.500, 1976.583, 1976.667, 1976.750, 1976.833, 1976.917) + c(0, 0, 79.09, 93.94, 154.9, 126.6, 76.78, 0, 0, 0, 0, 0))
#plot( c(time(milk_time), 1976.000, 1976.083, 1976.167, 1976.250, 1976.333, 1976.417, 1976.500, 1976.583, 1976.667, 1976.750, 1976.833, 1976.917), pred3, type='l', ylim = c(500, 1000))
#points(milk_time, type='o', col='red')
#pred3
```

